# Behavior Verification Flow
# ============================
# Staff logs a behavior -> Manager verifies -> Staff sees it verified
#
# This is a P0 multi-role flow that tests:
# - Staff behavior logging
# - Manager verification workflow
# - Cross-role data visibility
# - RBAC permissions (canVerifyLogs)

flow:
  id: behavior-verification
  name: "Behavior Verification Flow"
  description: "Complete multi-role flow: Staff logs behavior, Manager verifies, Staff sees verified result"
  narration: "This flow demonstrates the behavior verification workflow between staff and manager roles at AC Hotel."
  priority: p0
  tags:
    - multi-role
    - verification
    - behavior-logging

# ============================================================================
# ROLES
# ============================================================================
# Define which roles participate in this flow
# These map to fixtures from e2e/fixtures/multi-role.ts

roles:
  - type: STAFF
    fixture: staffPage
    user: staffUser
  - type: MANAGER
    fixture: managerPage
    user: managerUser

# ============================================================================
# STEPS
# ============================================================================
# Each step executes in order. Role switches between steps are handled by
# the test generator. Business logic checks run inline during the step.

steps:
  # --------------------------------------------------------------------------
  # STEP 1: Staff logs a behavior
  # --------------------------------------------------------------------------
  - id: staff-logs-behavior
    role: STAFF
    description: "Staff member logs a wine pairing recommendation"
    narration: "Sam, a server at AC Hotel, opens his staff dashboard. The header shows his name and role. He taps the Recommend wine pairing button and confirms with a second tap to log it."

    actions:
      # Navigate to staff page
      - type: navigate
        url: /staff

      # Wait for page to load - look for Log Behavior section
      - type: waitFor
        text: "Log Behavior"
        timeout: 5000

      # Click wine pairing behavior button (first tap)
      - type: click
        selector: "text=Recommend wine pairing"
        fallback:
          - "[data-testid='behavior-wine-pairing']"
          - "button:has-text('wine pairing')"
        waitAfter: 500

      # Wait for confirm prompt
      - type: waitFor
        text: "Tap again"
        timeout: 3000

      # Second tap to confirm
      - type: click
        selector: "text=Tap again"
        fallback:
          - "text=Confirm"
        waitAfter: 1000

    assertions:
      # Verify My Actions section is visible
      - type: visible
        selector: "text=My Actions"

    businessLogic:
      # Staff can delete their own unverified logs
      - function: canStaffDeleteLog
        args:
          isStaff: true
          isLogOwner: true
          isVerified: false
        expected:
          canDelete: true

      # Staff cannot verify logs
      - function: canVerifyLogs
        args:
          role: SERVER
        expected: false

      # Staff role is correctly classified
      - function: isStaffRole
        args:
          role: SERVER
        expected: true

  # --------------------------------------------------------------------------
  # STEP 2: Manager views pending verifications
  # --------------------------------------------------------------------------
  - id: manager-views-pending
    role: MANAGER
    description: "Manager navigates to verification page and sees pending logs"
    narration: "Meanwhile, Sarah the manager opens the verification page. She sees pending wine pairing recommendations waiting for verification."

    actions:
      # Navigate to verification page
      - type: navigate
        url: /manager/verification

      # Wait for page to load - look for heading
      - type: waitFor
        text: "Behavior Verification"
        timeout: 5000

      # Wait for pending logs to appear
      - type: waitFor
        text: "pending verifications"
        timeout: 5000

    assertions:
      # Verify pending verifications text is visible
      - type: visible
        selector: "text=pending verifications"

    businessLogic:
      # Manager can verify logs
      - function: canVerifyLogs
        args:
          role: MANAGER
        expected: true

      # Manager role is correctly classified
      - function: isManagerRole
        args:
          role: MANAGER
        expected: true

      # Manager can access verification feature
      - function: canAccessFeature
        args:
          role: MANAGER
          feature: verification
        expected: true

  # --------------------------------------------------------------------------
  # STEP 3: Manager verifies all pending behaviors
  # --------------------------------------------------------------------------
  - id: manager-verifies
    role: MANAGER
    description: "Manager bulk verifies all pending behaviors"
    narration: "Sarah clicks Select All to choose all pending behaviors, then clicks Verify Selected. A success toast appears, and the page now shows 'All caught up!' since there are no more pending behaviors."

    actions:
      # Click Select All button to select all pending
      - type: click
        selector: "button:has-text('Select All')"
        fallback:
          - "[data-testid='select-all']"
        waitAfter: 500

      # Click Verify Selected button
      - type: click
        selector: "button:has-text('Verify Selected')"
        fallback:
          - "[data-testid='verify-selected']"
        waitAfter: 2000

      # Wait for empty state to appear
      - type: waitFor
        text: "All caught up"
        timeout: 5000

    assertions:
      # Verify empty state message appears
      - type: visible
        selector: "text=All caught up"

    businessLogic:
      # After verification, staff can no longer delete
      - function: canStaffDeleteLog
        args:
          isStaff: true
          isLogOwner: true
          isVerified: true
        expected:
          canDelete: false
          reason: "Cannot delete verified logs"

  # --------------------------------------------------------------------------
  # STEP 4: Staff sees the verified status
  # --------------------------------------------------------------------------
  - id: staff-sees-verified
    role: STAFF
    description: "Staff navigates back to check their stats"
    narration: "Back on Sam's dashboard, his My Actions count has increased. The wine pairing recommendation now shows as verified, counting toward his performance score."

    actions:
      # Navigate to staff page
      - type: navigate
        url: /staff

      # Wait for page to load
      - type: waitFor
        text: "My Actions"
        timeout: 5000

    assertions:
      # Verify the page loaded and shows stats
      - type: visible
        selector: "text=My Actions"

      # Verify verified status is visible
      - type: visible
        selector: "text=verified"

# ============================================================================
# METADATA
# ============================================================================

metadata:
  # Flow-level settings
  timeout: 60000  # 60 second timeout per step
  retries: 1

  # Video recording settings
  video:
    enabled: true
    size:
      width: 1920
      height: 1080

  # Reporter settings for viewer
  reporter:
    includeTimestamps: true
    stepLabels: true
    roleIndicators: true

  # Required seed data
  seedRequirements:
    - type: user
      role: SERVER
      email: sam@achotel.com
    - type: user
      role: MANAGER
      email: sarah@achotel.com
    - type: behavior
      name: Recommend wine pairing

  # Documentation reference
  documentation:
    flow: docs/03-USER-FLOWS.md#42-behavior-verification-flow
    api: docs/06-API-SPECIFICATION.md
