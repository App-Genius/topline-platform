# Behavior Verification Flow
# ============================
# Staff logs a behavior -> Manager verifies -> Staff sees it verified
#
# This is a P0 multi-role flow that tests:
# - Staff behavior logging
# - Manager verification workflow
# - Cross-role data visibility
# - RBAC permissions (canVerifyLogs)

flow:
  id: behavior-verification
  name: "Behavior Verification Flow"
  description: "Complete multi-role flow: Staff logs behavior, Manager verifies, Staff sees verified result"
  narration: "This flow demonstrates the behavior verification workflow between staff and manager roles at AC Hotel."
  priority: p0
  tags:
    - multi-role
    - verification
    - behavior-logging

# ============================================================================
# ROLES
# ============================================================================
# Define which roles participate in this flow
# These map to fixtures from e2e/fixtures/multi-role.ts

roles:
  - type: STAFF
    fixture: staffPage
    user: staffUser
  - type: MANAGER
    fixture: managerPage
    user: managerUser

# ============================================================================
# STEPS
# ============================================================================
# Each step executes in order. Role switches between steps are handled by
# the test generator. Business logic checks run inline during the step.

steps:
  # --------------------------------------------------------------------------
  # STEP 1: Staff logs a behavior
  # --------------------------------------------------------------------------
  - id: staff-logs-behavior
    role: STAFF
    description: "Staff member logs a wine upsell behavior"
    narration: "Sam, a server at AC Hotel, opens his staff dashboard to log a wine upsell. He taps the Upsell Wine button and confirms with a second tap."

    actions:
      # Navigate to staff page
      - type: navigate
        url: /staff

      # Wait for page to load - look for LOG BEHAVIOR section
      - type: waitFor
        text: "LOG BEHAVIOR"
        timeout: 5000

      # Click Upsell Wine behavior button (first tap)
      - type: click
        selector: "text=Upsell Wine"
        fallback:
          - "[data-testid='behavior-upsell-wine']"
          - "button:has-text('Upsell Wine')"
        waitAfter: 500

      # Wait for confirm prompt
      - type: waitFor
        text: "Tap again"
        timeout: 3000

      # Second tap to confirm
      - type: click
        selector: "text=Tap again"
        fallback:
          - "text=Confirm"
        waitAfter: 1000

    assertions:
      # Verify MY ACTIONS section is visible
      - type: visible
        selector: "text=MY ACTIONS"

    businessLogic:
      # Staff can delete their own unverified logs
      - function: canStaffDeleteLog
        args:
          isStaff: true
          isLogOwner: true
          isVerified: false
        expected:
          canDelete: true

      # Staff cannot verify logs
      - function: canVerifyLogs
        args:
          role: SERVER
        expected: false

      # Staff role is correctly classified
      - function: isStaffRole
        args:
          role: SERVER
        expected: true

  # --------------------------------------------------------------------------
  # STEP 2: Manager views pending verifications
  # --------------------------------------------------------------------------
  - id: manager-views-pending
    role: MANAGER
    description: "Manager navigates to verification page and sees pending log"
    narration: "Meanwhile, Sarah the manager opens the verification page. She can see Sam's wine upsell is waiting for verification."

    actions:
      # Navigate to verification page
      - type: navigate
        url: /manager/verification

      # Wait for page to load - look for heading
      - type: waitFor
        text: "Behavior Verification"
        timeout: 5000

    assertions:
      # Verify pending count visible
      - type: visible
        selector: "text=pending verifications"
        fallback:
          - "text=pending"

    businessLogic:
      # Manager can verify logs
      - function: canVerifyLogs
        args:
          role: MANAGER
        expected: true

      # Manager role is correctly classified
      - function: isManagerRole
        args:
          role: MANAGER
        expected: true

      # Manager can access verification feature
      - function: canAccessFeature
        args:
          role: MANAGER
          feature: verification
        expected: true

  # --------------------------------------------------------------------------
  # STEP 3: Manager verifies the behavior
  # --------------------------------------------------------------------------
  - id: manager-verifies
    role: MANAGER
    description: "Manager clicks verify button on the first pending behavior"
    narration: "Sarah clicks the green verify button to confirm Sam's wine upsell was genuine. The behavior is now verified."

    actions:
      # Click the first green verify button (has title="Verify")
      - type: click
        selector: "button[title='Verify']"
        fallback:
          - "button.bg-emerald-100"
          - "[title='Verify']"
        waitAfter: 1000

    assertions:
      # Verify page still shows (verification happened)
      - type: visible
        selector: "text=Behavior Verification"

    businessLogic:
      # After verification, staff can no longer delete
      - function: canStaffDeleteLog
        args:
          isStaff: true
          isLogOwner: true
          isVerified: true
        expected:
          canDelete: false
          reason: "Cannot delete verified logs"

  # --------------------------------------------------------------------------
  # STEP 4: Staff sees the verified status
  # --------------------------------------------------------------------------
  - id: staff-sees-verified
    role: STAFF
    description: "Staff navigates back to check their stats"
    narration: "Back on Sam's dashboard, his wine upsell now shows as verified. It counts toward his performance score and appears in his actions."

    actions:
      # Navigate to staff page
      - type: navigate
        url: /staff

      # Wait for page to load
      - type: waitFor
        text: "MY ACTIONS"
        timeout: 5000

    assertions:
      # Verify the page loaded and shows stats
      - type: visible
        selector: "text=MY ACTIONS"

      # Verify AVG CHECK is visible
      - type: visible
        selector: "text=AVG CHECK"

# ============================================================================
# METADATA
# ============================================================================

metadata:
  # Flow-level settings
  timeout: 30000  # 30 second timeout per step
  retries: 1

  # Video recording settings
  video:
    enabled: true
    size:
      width: 1920
      height: 1080

  # Reporter settings for viewer
  reporter:
    includeTimestamps: true
    stepLabels: true
    roleIndicators: true

  # Required seed data
  seedRequirements:
    - type: user
      role: SERVER
      email: sam@achotel.com
    - type: user
      role: MANAGER
      email: sarah@achotel.com
    - type: behavior
      name: Wine Pairing

  # Documentation reference
  documentation:
    flow: docs/03-USER-FLOWS.md#42-behavior-verification-flow
    api: docs/06-API-SPECIFICATION.md
